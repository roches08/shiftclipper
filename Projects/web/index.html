<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShiftClipper Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f7fb; }
    .card { background: #fff; border: 1px solid #d9e2ef; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-size:12px; color:#516; }
    .hint { font-size:12px; color:#555; }
    .warn { background:#fff4d6; border:1px solid #f3cd68; padding:8px; border-radius:8px; margin-bottom:10px; display:none; }
    .videoWrap { position: relative; max-width: 900px; }
    video { width:100%; background:black; border-radius:8px; }
    canvas { position:absolute; left:0; top:0; pointer-events:none; }
    details { margin-top: 8px; }
    pre { background:#101827; color:#d0e0ff; padding:8px; border-radius:6px; overflow:auto; }
    progress { width: 100%; height: 16px; }
    .stepper { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 6px; margin-top: 10px; }
    .step { border: 1px solid #d8dfef; border-radius: 8px; padding: 6px 8px; font-size: 12px; color: #516; display: flex; gap: 6px; align-items: center; }
    .step.active { border-color: #3d7cff; color: #1d3f9b; background: #ecf2ff; }
    .step.done { border-color: #3ca55c; color: #206533; background: #e9f8ee; }
    .step.failed { border-color: #cf3f3f; color: #882222; background: #ffefef; }
  </style>
</head>
<body>
<h2>ShiftClipper — Tracker v2</h2>
<div id="verifyBanner" class="warn">Verify mode is ON: this run will NOT generate clips or a combined MP4.</div>
<div class="card">
  <div class="row">
    <button id="btnCreate">Create Job</button>
    <button id="btnUpload" disabled>Upload</button>
    <button id="btnSave" disabled>Save setup</button>
    <button id="btnRun" disabled>Run</button>
    <button id="btnCancel" disabled>Cancel Job</button>
    <button id="btnClear" disabled>Clear Job</button>
    <span>Job: <b id="jobId">—</b></span>
  </div>
  <div class="row" style="margin-top:8px;">
    <input id="file" type="file" accept="video/*" />
    <label>Camera Mode</label>
    <select id="cameraMode">
      <option value="broadcast">Broadcast</option>
      <option value="broadcast_wide">Broadcast (Wide / Youth)</option>
      <option value="tactical">Tactical (Overhead/Wide)</option>
    </select>
    <label>Tracking Mode</label>
    <select id="trackingMode">
      <option value="clip">Clips (Highlights)</option>
      <option value="shift">Shifts (TOI)</option>
    </select>
    <label>Verify Mode</label>
    <select id="verifyMode"><option value="off">off</option><option value="on">on</option></select>
    <label><input id="skipSeeding" type="checkbox" /> Skip seeding</label>
    <span id="seedStatus" class="hint">Seed clicks: 0</span>
    <button id="btnUndoClick" type="button">Undo last click</button>
    <button id="btnClearClicks" type="button">Clear seed clicks</button>
    <span id="seedClicksList" class="hint">—</span>
  </div>
  <div class="hint" id="cameraHelp"></div>
  <div class="hint" id="trackingHelp"></div>
  <div class="hint">Tracking tip: wide, stable, single-angle videos usually track best; broadcast cuts/zooms can reduce accuracy.</div>

  <div class="row" style="margin-top:8px;">
    <label>Jersey #</label><input id="playerNumber" style="width:70px" />
    <label>Jersey color</label><input id="jerseyColor" type="color" value="#1d3936" />
    <label>Opponent color</label><input id="opponentColor" type="color" value="#ffffff" />
    <label>Color tolerance</label><input id="colorTolerance" type="range" min="5" max="60" value="26" />
    <label>Extend sec</label><input id="extendSec" type="number" value="20" />
  </div>

  <details>
    <summary>Advanced Tracking Settings</summary>
    <div class="row" style="margin:8px 0;">
      <button id="presetBalanced" type="button">Balanced</button>
      <button id="presetMoreClips" type="button">More Clips</button>
      <button id="presetTrackQuality" type="button">Track Quality</button>
    </div>
    <div class="row">
      <label>Score lock threshold</label><input id="scoreLockThreshold" type="number" step="0.01" value="0.55" min="0" max="1" />
      <label>Score unlock threshold</label><input id="scoreUnlockThreshold" type="number" step="0.01" value="0.33" min="0" max="1" />
      <label>Lost timeout</label><input id="lostTimeout" type="number" step="0.1" value="4.0" min="0" />
      <label>Reacquire window (s)</label><input id="reacquireWindowSeconds" type="number" step="0.1" value="8.0" min="0" />
      <label>Reacquire score lock threshold</label><input id="reacquireScoreLockThreshold" type="number" step="0.01" value="0.4" min="0" max="1" />
      <label>Gap merge seconds</label><input id="mergeGap" type="number" step="0.1" value="2.5" min="0" />
      <label>Lock seconds after confirm</label><input id="lockSeconds" type="number" step="0.1" value="4" min="0" />
      <label>Min track seconds</label><input id="minTrack" type="number" step="0.05" value="0.75" min="0" />
      <label>Min clip seconds</label><input id="minClipSeconds" type="number" step="0.05" value="1" min="0" />
      <label>Allow unconfirmed clips</label><input id="allowUnconfirmedClips" type="checkbox" />
      <label>Allow seed clips</label><input id="allowSeedClips" type="checkbox" checked />
      <label>Seed lock seconds</label><input id="seedLockSeconds" type="number" step="0.1" value="8" min="0" />
      <label>Seed IOU min</label><input id="seedIouMin" type="number" step="0.01" value="0.12" min="0" max="1" />
      <label>Seed dist max</label><input id="seedDistMax" type="number" step="0.01" value="0.16" min="0" max="1" />
      <label>Seed bonus</label><input id="seedBonus" type="number" step="0.01" value="0.8" min="0" />
      <label>Seed window s</label><input id="seedWindowS" type="number" step="0.1" value="3" min="0" />
      <label>OCR disable</label><input id="ocrDisable" type="checkbox" />
      <label>OCR every n frames</label><input id="ocrEveryNFrames" type="number" step="1" value="12" min="1" />
      <label>OCR min confidence</label><input id="ocrMinConf" type="number" step="0.01" value="0.2" min="0" max="1" />
      <label>OCR veto conf</label><input id="ocrVetoConf" type="number" step="0.01" value="0.92" min="0" max="1" />
      <label>OCR veto seconds</label><input id="ocrVetoSeconds" type="number" step="0.1" value="1.0" min="0" />
      <label>Detect stride</label><input id="detectStride" type="number" value="2" min="1" />
      <label>YOLO imgsz</label><input id="yoloImgsz" type="number" value="512" min="256" max="1280" />
      <label>YOLO batch</label><input id="yoloBatch" type="number" value="4" min="1" />
      <label>Tracker type</label><input id="trackerType" type="text" value="bytetrack" />
      <label>ReID enabled</label><input id="reidEnable" type="checkbox" checked />
      <label>ReID model</label><input id="reidModel" type="text" value="osnet_x0_25" />
      <label>ReID every n frames</label><input id="reidEveryNFrames" type="number" step="1" value="5" min="1" />
      <label>ReID weight</label><input id="reidWeight" type="number" step="0.01" value="0.45" min="0" max="1" />
      <label>ReID min similarity</label><input id="reidMinSim" type="number" step="0.01" value="0.50" min="0" max="1" />
      <label>ReID crop expand</label><input id="reidCropExpand" type="number" step="0.01" value="0.15" min="0" max="1" />
      <label>ReID batch</label><input id="reidBatch" type="number" step="1" value="16" min="1" />
      <label>ReID device</label><input id="reidDevice" type="text" value="cuda:0" />
      <label>Swap guard seconds</label><input id="swapGuardSeconds" type="number" step="0.1" value="2.5" min="0" />
      <label>Swap guard bonus</label><input id="swapGuardBonus" type="number" step="0.01" value="0.10" min="0" />
      <label>Transcode for tracking (recommended for messy footage)</label><input id="transcodeEnabled" type="checkbox" />
      <label>Max transcode resolution</label><input id="transcodeScaleMax" type="number" min="360" step="2" value="1080" />
      <label>Force transcode FPS (optional)</label><input id="transcodeFps" type="number" min="1" step="1" placeholder="keep source" />
      <label>Auto deinterlace</label><input id="transcodeDeinterlace" type="checkbox" checked />
      <label>Denoise before tracking</label><input id="transcodeDenoise" type="checkbox" />
      <span id="shiftOnly">
        <label>Bench zone ratio</label><input id="benchZone" type="number" step="0.01" value="0.80" />
      </span>
    </div>
  </details>
  <details>
    <summary>Debug Outputs</summary>
    <div class="row">
      <label>Generate debug overlay video</label><input id="debugOverlay" type="checkbox" />
      <label>Save debug timeline JSON</label><input id="debugTimeline" type="checkbox" checked />
    </div>
  </details>
</div>

<div class="card">
  <h3>Progress</h3>
  <progress id="overallProgress" max="100" value="0"></progress>
  <div class="row" style="justify-content:space-between;margin-top:6px;">
    <div id="progressMessage">—</div>
    <b id="overallProgressText">0%</b>
  </div>
  <div class="stepper" id="stepper"></div>
</div>

<div class="card">
  <div class="videoWrap"><video id="vid" controls></video><canvas id="seedCanvas"></canvas></div>
</div>
<div class="card"><h3>Status</h3><pre id="out">{}</pre></div>
<div class="card"><h3>Results</h3><div id="resultsMessage">—</div><div id="artifacts"></div><pre id="clips">—</pre></div>
<script src="/static/presets.js" defer></script>
<script src="/static/app.js" defer></script>
</body>
</html>
