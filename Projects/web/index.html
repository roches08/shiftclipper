<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShiftClipper Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f7fb; }
    .card { background: #fff; border: 1px solid #d9e2ef; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-size:12px; color:#516; }
    .hint { font-size:12px; color:#555; }
    .warn { background:#fff4d6; border:1px solid #f3cd68; padding:8px; border-radius:8px; margin-bottom:10px; display:none; }
    .videoWrap { position: relative; max-width: 900px; }
    video { width:100%; background:black; border-radius:8px; }
    canvas { position:absolute; left:0; top:0; pointer-events:none; }
    details { margin-top: 8px; }
    pre { background:#101827; color:#d0e0ff; padding:8px; border-radius:6px; overflow:auto; }
    progress { width: 100%; height: 16px; }
    .stepper { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 6px; margin-top: 10px; }
    .step { border: 1px solid #d8dfef; border-radius: 8px; padding: 6px 8px; font-size: 12px; color: #516; display: flex; gap: 6px; align-items: center; }
    .step.active { border-color: #3d7cff; color: #1d3f9b; background: #ecf2ff; }
    .step.done { border-color: #3ca55c; color: #206533; background: #e9f8ee; }
    .step.failed { border-color: #cf3f3f; color: #882222; background: #ffefef; }
  </style>
</head>
<body>
<h2>ShiftClipper — Tracker v2</h2>
<div id="verifyBanner" class="warn">Verify mode is ON: this run will NOT generate clips or a combined MP4.</div>
<div class="card">
  <div class="row">
    <button id="btnCreate">Create Job</button>
    <button id="btnUpload" disabled>Upload</button>
    <button id="btnSave" disabled>Save setup</button>
    <button id="btnRun" disabled>Run</button>
    <button id="btnCancel" disabled>Cancel Job</button>
    <button id="btnClear" disabled>Clear Job</button>
    <span>Job: <b id="jobId">—</b></span>
  </div>
  <div class="row" style="margin-top:8px;">
    <input id="file" type="file" accept="video/*" />
    <label>Camera Mode</label>
    <select id="cameraMode">
      <option value="broadcast">Broadcast</option>
      <option value="broadcast_wide">Broadcast (Wide / Youth)</option>
      <option value="tactical">Tactical (Overhead/Wide)</option>
    </select>
    <label>Tracking Mode</label>
    <select id="trackingMode">
      <option value="clip">Clips (Highlights)</option>
      <option value="shift">Shifts (TOI)</option>
    </select>
    <label>Verify Mode</label>
    <select id="verifyMode"><option value="off">off</option><option value="on">on</option></select>
    <label><input id="skipSeeding" type="checkbox" /> Skip seeding</label>
    <span id="seedStatus" class="hint">Seed clicks: 0</span>
    <button id="btnUndoClick" type="button">Undo last click</button>
    <button id="btnClearClicks" type="button">Clear seed clicks</button>
    <span id="seedClicksList" class="hint">—</span>
  </div>
  <div class="hint" id="cameraHelp"></div>
  <div class="hint" id="trackingHelp"></div>

  <div class="row" style="margin-top:8px;">
    <label>Jersey #</label><input id="playerNumber" style="width:70px" />
    <label>Jersey color</label><input id="jerseyColor" type="color" value="#1d3936" />
    <label>Color tolerance</label><input id="colorTolerance" type="range" min="5" max="60" value="26" />
    <label>Extend sec</label><input id="extendSec" type="number" value="20" />
  </div>

  <details>
    <summary>Advanced Tracking Settings</summary>
    <div class="row" style="margin:8px 0;">
      <button id="presetBalanced" type="button">Balanced (default)</button>
      <button id="presetAggressive" type="button">More Clips (aggressive)</button>
      <button id="presetStrict" type="button">Track Quality (strict)</button>
    </div>
    <div class="row">
      <label title="Confidence needed to lock onto a target track (0..1).">Score lock threshold</label><input id="scoreLockThreshold" type="number" step="0.01" min="0" max="1" value="0.55" />
      <label title="Confidence threshold to release a lock (0..1).">Score unlock threshold</label><input id="scoreUnlockThreshold" type="number" step="0.01" min="0" max="1" value="0.35" />
      <label title="Seconds to tolerate missing detections before dropping track.">Lost timeout</label><input id="lostTimeout" type="number" step="0.1" min="0" value="1.5" />
      <label title="How long to allow reacquisition after loss.">Reacquire window (s)</label><input id="reacquireWindowSeconds" type="number" step="0.1" min="0" value="4" />
      <label title="Score threshold used during reacquisition.">Reacquire score lock</label><input id="reacquireScoreLockThreshold" type="number" step="0.01" min="0" max="1" value="0.4" />
      <label title="Merge nearby segments separated by up to this many seconds.">Gap merge (s)</label><input id="mergeGap" type="number" step="0.1" min="0" value="2.5" />
      <label title="Keep lock for this long after a confirmed detection.">Lock after confirm (s)</label><input id="lockSeconds" type="number" step="0.1" min="0" value="4" />
      <label title="Minimum tracked segment duration.">Min track (s)</label><input id="minTrack" type="number" step="0.05" min="0" value="0.75" />
      <label title="Minimum clip duration after segment merge.">Min clip (s)</label><input id="minClipSeconds" type="number" step="0.05" min="0" value="1" />
      <label title="Allow clips from unconfirmed tracks."><input id="allowUnconfirmedClips" type="checkbox" /> Allow unconfirmed clips</label>
      <label title="Allow seed-based clips when confidence is low."><input id="allowSeedClips" type="checkbox" checked /> Allow seed clips</label>
      <label title="Time to keep a seed lock active.">Seed lock (s)</label><input id="seedLockSeconds" type="number" step="0.1" min="0" value="8" />
      <label title="Minimum IoU to match seed with detection.">Seed IoU min</label><input id="seedIouMin" type="number" step="0.01" min="0" max="1" value="0.12" />
      <label title="Maximum normalized distance to match seed.">Seed distance max</label><input id="seedDistMax" type="number" step="0.01" min="0" max="1" value="0.16" />
      <label title="Seed score bonus added during matching.">Seed bonus</label><input id="seedBonus" type="number" step="0.01" min="0" value="0.8" />
      <label title="Seconds around seed click to prioritize matching.">Seed window (s)</label><input id="seedWindowS" type="number" step="0.1" min="0" value="3" />
      <label title="Disable OCR influence entirely."><input id="ocrDisable" type="checkbox" /> Disable OCR</label>
      <label title="Run OCR every N frames.">OCR every N frames</label><input id="ocrEveryNFrames" type="number" step="1" min="1" value="12" />
      <label title="Minimum OCR confidence used for positive evidence.">OCR min conf</label><input id="ocrMinConf" type="number" step="0.01" min="0" max="1" value="0.2" />
      <label title="OCR confidence that can veto a track.">OCR veto conf</label><input id="ocrVetoConf" type="number" step="0.01" min="0" max="1" value="0.85" />
      <label title="How long OCR veto remains active.">OCR veto seconds</label><input id="ocrVetoSeconds" type="number" step="0.1" min="0" value="2" />
      <label title="Run YOLO detection every Nth frame.">Detect stride</label><input id="detectStride" type="number" step="1" min="1" value="2" />
      <label title="YOLO inference image size.">YOLO image size</label><input id="yoloImgsz" type="number" step="1" min="256" max="1280" value="512" />
      <label title="YOLO batch size for detector.">YOLO batch</label><input id="yoloBatch" type="number" step="1" min="1" value="4" />
      <label title="Tracker implementation used by worker.">Tracker type</label>
      <select id="trackerType">
        <option value="bytetrack">ByteTrack</option>
        <option value="iou">IOU</option>
        <option value="deepsort">DeepSort</option>
      </select>
      <span id="shiftOnly">
        <label title="Relative bench-zone boundary for shift mode.">Bench zone ratio</label><input id="benchZone" type="number" step="0.01" value="0.80" />
      </span>
    </div>
  </details>
  <details>
    <summary>Debug Outputs</summary>
    <div class="row">
      <label>Generate debug overlay video</label><input id="debugOverlay" type="checkbox" />
      <label>Save debug timeline JSON</label><input id="debugTimeline" type="checkbox" checked />
    </div>
  </details>
</div>

<div class="card">
  <h3>Progress</h3>
  <progress id="overallProgress" max="100" value="0"></progress>
  <div class="row" style="justify-content:space-between;margin-top:6px;">
    <div id="progressMessage">—</div>
    <b id="overallProgressText">0%</b>
  </div>
  <div class="stepper" id="stepper"></div>
</div>

<div class="card">
  <div class="videoWrap"><video id="vid" controls></video><canvas id="seedCanvas"></canvas></div>
</div>
<div class="card"><h3>Status</h3><pre id="out">{}</pre></div>
<div class="card"><h3>Results</h3><div id="resultsMessage">—</div><div id="artifacts"></div><pre id="clips">—</pre></div>
<script src="/static/app.js" defer></script>
</body>
</html>
